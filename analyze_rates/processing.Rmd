---
title: "Analysis of model fit, accuracy for LEISR rates"
author: "Stephanie J. Spielman"
date: "11/2/2017"
output: 
  html_document:
    theme: spacelab
    highlight: pygments
---

```{r setup, include=FALSE}
require(tidyverse)
require(cowplot)
require(purrr)
require(broom)
theme_set(theme_classic() + theme(axis.title = element_text(size=11), axis.text = element_text(size=10)))
knitr::opts_chunk$set(echo = TRUE, fig.align="center", fig.height=5, fig.width=5)
```

### Read in all data

First, read in all relevant data:

+ `model.fit` will contain AICc and LogL per inference
+ `raw.rates` will contain site-wise rate MLEs per inference

```{r prep,message=FALSE}
model.fit <- read.csv("model_fits.csv") ### AICc and LogL per inference

fpath = "inference/"
files <- dir(path = fpath, pattern = "*csv")
data_frame(filename = files) %>%
  mutate(file_contents = map(filename,
           ~ read_csv(file.path(fpath, .)))) %>%
  unnest() %>%
  separate(filename, c("dataset", "byebye1", "model", "byebye2", "byebye3"), sep="\\.") %>%
  dplyr::select(dataset, model, site, rate) -> raw.rates
```


### Analyze model fit

Here, we wish to get a sense of model fit across the 100 datasets, based on AICc.  


First, we rank the 8 inferences per dataset by AICc and calculate dAICc from the minimum AICc per dataset:
```{r}
model.fit %>% 
    group_by(dataset) %>%
    arrange(dataset, AICc) %>%
    mutate(AICc_rank = rank(AICc)) %>% 
    mutate(deltaAICc = min(AICc) - AICc) -> model.aicc
model.aicc
```


<br><br>
We now can determine two quantities: What are the top models, and what are the $\Delta$AICc between models 1 and 2, per dataset? 
```{r, message=FALSE}
#### Determine frequencies for top models
model.aicc %>% 
    filter(AICc_rank == 1) %>% 
    group_by(model) %>%
    tally() 

#### Summarize AICc differences b/w rank 1 and 2 for each dataset
model.aicc %>% 
    filter(AICc_rank == 2) %>% 
    ungroup() %>%
    summarize(mean(deltaAICc), median(deltaAICc), min(abs(deltaAICc)), max(abs(deltaAICc)))

### Visualize dAICc
model.aicc %>% 
    filter(AICc_rank == 2) %>% 
    ggplot(aes(x = -1*deltaAICc)) + geom_histogram(fill = "white", color = "navy")
```

A few conclusions follow from above:

+ `WAG-G` is the most commonly preferred model, and further 90/100 of the preferred models include Gamma rate variation
+ $\Delta$AICc values between "best" and "second best" model range from [27.5, 29917.6], with a median of 1189.324 and mean of 1958.13. The minimum of 27.5 tells us that all "best" models are indeed strongly preferred, and the mean vs. median tells us that the distributed is skewed towards *larger* $\Delta$AICc.

<br>

### Compare rates with and without rate variation


For ease in processing, first spread the rates across models. Additionally perform this for three common normalization schemes:

+ Normalize by mean
+ Normalize by median
+ Covert to Z-scores

We additionally perform many analyes on a log-scale, so first add a `1e-5` fudge to all rates.

```{r message=FALSE}
fudge <- 1e-5
raw.rates <- raw.rates %>% mutate(rate = rate + fudge)


### Spread, no normalization
rates <- raw.rates %>% 
            group_by(dataset, model) %>% 
            spread(model, rate)

### Spread, normalized by mean   
normmean <- raw.rates %>% 
                group_by(dataset, model) %>% 
                mutate(normrate = rate/mean(rate)) %>%
                select(-rate) %>%
                spread(model, normrate)

## Spread, normalized by median
normmedian <- raw.rates %>% 
                group_by(dataset, model) %>% 
                mutate(normrate = rate/median(rate)) %>%
                select(-rate) %>%
                spread(model, normrate) 

## Spread, z-score-ify
zrates <- raw.rates %>% 
                group_by(dataset, model) %>% 
                mutate(zscore = (rate - mean(rate))/sd(rate)) %>%
                select(-rate) %>%
                spread(model, zscore) 
```

<br>

Using an example dataset, plot rates across schemes against each other, aross normalization schemes:

**Regular rates**
```{r message=FALSE, fig.height=2, fig.width=8}
repr <- "1DBT_A"

rates %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `LG-G`, y = `LG-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("LG G vs noRV")+ scale_x_log10() + scale_y_log10() -> g1

rates %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `WAG-G`, y = `WAG-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("WAG G vs noRV")+ scale_x_log10() + scale_y_log10() -> g2

rates %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `JTT-G`, y = `JTT-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("JTT G vs noRV")+ scale_x_log10() + scale_y_log10() -> g3

rates %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `JC69-G`, y = `JC69-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("JC G vs noRV")+ scale_x_log10() + scale_y_log10() -> g4

plot_grid(g1,g2,g3,g4, nrow=1)
```


**Mean rates**
```{r message=FALSE, fig.height=2, fig.width=8}
repr <- "1DBT_A"

normmean %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `LG-G`, y = `LG-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("LG G vs noRV")+ scale_x_log10() + scale_y_log10() -> g1

normmean %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `WAG-G`, y = `WAG-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("WAG G vs noRV")+ scale_x_log10() + scale_y_log10() -> g2

normmean %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `JTT-G`, y = `JTT-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("JTT G vs noRV")+ scale_x_log10() + scale_y_log10() -> g3

normmean %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `JC69-G`, y = `JC69-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("JC G vs noRV")+ scale_x_log10() + scale_y_log10() -> g4

plot_grid(g1,g2,g3,g4, nrow=1)
```


**Median rates**
```{r message=FALSE, fig.height=2, fig.width=8}
repr <- "1DBT_A"

normmedian %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `LG-G`, y = `LG-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("LG G vs noRV")+ scale_x_log10() + scale_y_log10() -> g1

normmedian %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `WAG-G`, y = `WAG-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("WAG G vs noRV")+ scale_x_log10() + scale_y_log10() -> g2

normmedian %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `JTT-G`, y = `JTT-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("JTT G vs noRV")+ scale_x_log10() + scale_y_log10() -> g3

normmedian %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `JC69-G`, y = `JC69-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("JC G vs noRV")+ scale_x_log10() + scale_y_log10() -> g4

plot_grid(g1,g2,g3,g4, nrow=1)
```

**Z-scores**, but not on a log-scale because they are Z-scores. Instead, plots show non-outliers only.
```{r message=FALSE, fig.height=2, fig.width=8}
repr <- "1DBT_A"

zrates %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `LG-G`, y = `LG-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("LG G vs noRV") + coord_cartesian(xlim=c(-0.5,0.5), ylim=c(-0.5,0.5))-> g1

zrates %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `WAG-G`, y = `WAG-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("WAG G vs noRV")  + coord_cartesian(xlim=c(-0.5,0.5), ylim=c(-0.5,0.5))-> g2

zrates %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `JTT-G`, y = `JTT-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("JTT G vs noRV") + coord_cartesian(xlim=c(-0.5,0.5), ylim=c(-0.5,0.5))-> g3

zrates %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `JC69-G`, y = `JC69-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("JC G vs noRV") + coord_cartesian(xlim=c(-0.5,0.5), ylim=c(-0.5,0.5))-> g4

plot_grid(g1,g2,g3,g4, nrow=1)
```


<br>

Rough conclusions from plotting:

+ Rates and median-normalized rates are virtually identical with and without the Gamma
+ Mean-normalized rates have the potential to induce biases in this relationship, likely driven by the fact that rate distributions are highly-skewed
+ Converting rates to z-scores tends to somewhat destroy this relationship, likely because, again, we have overdispersed distributions relative to what Z transformation is expecting


<br><br>

### Compare rates across models

Given the comparability of rates with and without Gamma, remaining efforts are focused on NoRV rates alone. We further focus our attention just on the unnormalized rates.

We now wish to compare inferences among matrices, again now just for a representative dataset
```{r message=FALSE, fig.height=4, fig.width=8}
repr <- "1DBT_A"

rates %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `LG-No`, y = `WAG-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("LG vs WAG")+ scale_x_log10() + scale_y_log10() -> g1

rates %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `LG-No`, y = `JTT-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("LG vs JTT")+ scale_x_log10() + scale_y_log10() -> g2

rates %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `LG-No`, y = `JC69-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("LG vs JC69")+ scale_x_log10() + scale_y_log10() -> g3

rates %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `WAG-No`, y = `JTT-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("WAG vs JTT")+ scale_x_log10() + scale_y_log10() -> g4

rates %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `WAG-No`, y = `JC69-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("WAG vs JC69")+ scale_x_log10() + scale_y_log10() -> g5

rates %>%
  filter(dataset == repr) %>%
  ggplot(aes(x = `JTT-No`, y = `JC69-No`)) + geom_point() + geom_abline(color="blue") + ggtitle("JTT vs JC69")+ scale_x_log10() + scale_y_log10() -> g6


plot_grid(g1,g2,g3,g4,g5,g6, nrow=2)
```

<br>

The plot above shows an important conclusion: Rates across methods are virtually identical, **with the exception** of JC69, which shows substantial bias at "difficult to estimate" sites, i.e. those with very high or very low rates. Notably, rates of ~0 are not biased, because no evolution is no evolution is no evolution.


### Model rate differences: Gamma vs no rate variation

In this section, we construct some rank models to get a clear sense of how rates relate across inference models, specifically between the same matrix with and without rate variation

**Rank correlation and bias for Gamma vs no rate variation**
```{r message=FALSE}
### Rank correlations, mean+-sd
rates %>%
    na.omit() %>%  ##### TODO
    group_by(dataset) %>%
    do(corLG = cor(.$`LG-G`, .$`LG-No`, method = "spearman"),
       corWAG = cor(.$`WAG-G`, .$`WAG-No`, method = "spearman"),
       corJTT = cor(.$`JTT-G`, .$`JTT-No`, method = "spearman"),
       corJC69 = cor(.$`JC69-G`, .$`JC69-No`, method = "spearman")) %>%
    unnest(corLG, corWAG, corJTT, corJC69) %>%
    summarize(mean(corLG), 
              mean(corWAG), 
              mean(corJTT), 
              mean(corJC69), 
              sd(corLG), 
              sd(corWAG), 
              sd(corJTT), 
              sd(corJC69)) %>% print.data.frame()



### Bias from rank regression, with Bonferroni
rates %>%
    na.omit() %>%
    group_by(dataset) %>%
    mutate(rankLGG = rank(`LG-G`), rankLGNo = rank(`LG-No`)) %>%
    do(fitLG = lm(rankLGG ~ rankLGNo, data=.)) %>%
    tidy(fitLG) %>%
    filter(term == "(Intercept)", p.value <= 0.01/nrow(.)) %>%
    nrow()   



rates %>%
    group_by(dataset) %>%
    na.omit() %>%
    mutate(rankWAGG = rank(`WAG-G`), rankWAGNo = rank(`WAG-No`)) %>%
    do(fitWAG = lm(rankWAGG ~ rankWAGNo, data=.)) %>%
    tidy(fitWAG) %>%
    filter(term == "(Intercept)", p.value <= 0.01/nrow(.)) %>%
    nrow()   



rates %>%
    group_by(dataset) %>%
    na.omit() %>%
    mutate(rankJTTG = rank(`JTT-G`), rankJTTNo = rank(`JTT-No`)) %>%
    do(fitJTT = lm(rankJTTG ~ rankJTTNo, data=.)) %>%
    tidy(fitJTT) %>%
    filter(term == "(Intercept)", p.value <= 0.01/nrow(.)) %>%
    nrow()   


rates %>%
    group_by(dataset) %>%
    na.omit() %>%
    mutate(rankJC69G = rank(`JC69-G`), rankJC69No = rank(`JC69-No`)) %>%
    do(fitJC69 = lm(rankJC69G ~ rankJC69No, data=.)) %>%
    tidy(fitJC69) %>%
    filter(term == "(Intercept)", p.value <= 0.01/nrow(.)) %>%
    nrow()   
```


<br>

Here, we see:

+ Between gamma and no variation for a given model, inferences are essentially identical.
+ There is no evidence for any inference bias induced by rate variation. 


<br>


### Model rate differences: Across matrices 

In this section, we construct some rank models to get a clear sense of how rates relate across different matrices, again with just the no rate variation runs.


```{r message=FALSE}

## rank correlation b/w matrices
rates %>%
    group_by(dataset) %>%
    na.omit() %>%
    do(LGWAG = cor(.$`LG-No`, .$`WAG-No`, method = "spearman"),
       LGJTT = cor(.$`LG-No`, .$`JTT-No`, method = "spearman"),
       LGJC = cor(.$`LG-No`, .$`JC69-No`, method = "spearman"),
       WAGJTT = cor(.$`WAG-No`, .$`JTT-No`, method = "spearman"),
       WAGJC = cor(.$`LG-No`, .$`JC69-No`, method = "spearman"),
       JTTJC = cor(.$`JTT-No`, .$`JC69-No`, method = "spearman")) %>%
    unnest(LGWAG, LGJTT, LGJC, WAGJTT, WAGJC, JTTJC) %>% 
    summarize(mean(LGWAG), 
              mean(LGJTT), 
              mean(LGJC), 
              mean(WAGJTT), 
              mean(WAGJC), 
              mean(JTTJC), 
              sd(LGWAG), 
              sd(LGJTT), 
              sd(LGJC), 
              sd(WAGJTT), 
              sd(WAGJC), 
              sd(JTTJC)) %>% print.data.frame()


### LG-WAG
rates %>%
    group_by(dataset) %>%
    na.omit() %>%
    mutate(rankLG = rank(`LG-No`), rankWAG = rank(`WAG-No`)) %>%
    do(fit = lm(rankLG ~ rankWAG, data=.)) %>%
    tidy(fit) %>%
    filter(term == "(Intercept)", p.value <= 0.01/nrow(.)) %>%
    nrow() 

### LG-JTT
rates %>%
    group_by(dataset) %>%
    na.omit() %>%
    mutate(rankLG = rank(`LG-No`), rankJTT = rank(`JTT-No`)) %>%
    do(fit = lm(rankLG ~ rankJTT, data=.)) %>%
    tidy(fit) %>%
    filter(term == "(Intercept)", p.value <= 0.01/nrow(.)) %>%
    nrow() 

## LG-JC69
rates %>%
    group_by(dataset) %>%
    na.omit() %>%
    mutate(rankLG = rank(`LG-No`), rankJC= rank(`JC69-No`)) %>%
    do(fit = lm(rankLG ~ rankJC, data=.)) %>%
    tidy(fit) %>%
    filter(term == "(Intercept)", p.value <= 0.01/nrow(.)) %>%
    nrow() 

### WAG-JTT
rates %>%
    group_by(dataset) %>%
    na.omit() %>%
    mutate(rankWAG = rank(`WAG-No`), rankJTT = rank(`JTT-No`)) %>%
    do(fit = lm(rankWAG ~ rankJTT, data=.)) %>%
    tidy(fit) %>%
    filter(term == "(Intercept)", p.value <= 0.01/nrow(.)) %>%
    nrow() 

## WAG-JC69
rates %>%
    group_by(dataset) %>%
    na.omit() %>%
    mutate(rankWAG = rank(`WAG-No`), rankJC= rank(`JC69-No`)) %>%
    do(fit = lm(rankWAG ~ rankJC, data=.)) %>%
    tidy(fit) %>%
    filter(term == "(Intercept)", p.value <= 0.01/nrow(.)) %>%
    nrow() 

## JTT-JC69
rates %>%
    group_by(dataset) %>%
    na.omit() %>%
    mutate(rankJTT = rank(`JTT-No`), rankJC = rank(`JC69-No`)) %>%
    do(fit = lm(rankJTT ~ rankJC, data=.)) %>%
    tidy(fit) %>%
    filter(term == "(Intercept)", p.value <= 0.01/nrow(.)) %>%
    nrow() 
```


